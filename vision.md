# Техническое видение проекта - Telegram Bot для VPN

## 1. Технологии

### Основные технологии:
- **Python 3.13** - основной язык разработки
- **python-telegram-bot** - библиотека для работы с Telegram Bot API
- **SQLite** - простая файловая база данных (без дополнительной настройки)
- **APScheduler** - для планирования напоминаний об оплате
- **python-dotenv** - для управления переменными окружения
- **Amnezia VPN** - интеграция через API или файловую систему

### Конфигурация окружения:
Переменные в `.env` файле:
- `BOT_TOKEN` - токен Telegram бота
- `ADMIN_CHAT_ID` - ID администратора для уведомлений
- `VPN_SERVER_CONFIG_PATH` - путь к конфигурациям Amnezia
- `DATABASE_PATH` - путь к SQLite базе
- `PAYMENT_REMINDER_DAYS` - за сколько дней напоминать об оплате

### Дополнительные библиотеки:
- **logging** (встроенный) - для логирования
- **datetime** (встроенный) - для работы с датами

---

## 2. Принцип разработки

### Основные принципы:
1. **KISS (Keep It Simple, Stupid)** - максимальная простота во всем
2. **MVP подход** - минимально жизнеспособный продукт для проверки гипотезы
3. **Итеративная разработка** - сначала базовый функционал, потом улучшения
4. **Монолитная архитектура** - все в одном файле/модуле для простоты

### Подход к разработке:
- **Один основной файл** (`main.py`) с базовой логикой
- **Простые функции** без сложной архитектуры
- **Минимум зависимостей** - только необходимые библиотеки
- **Быстрое прототипирование** - фокус на работающем решении
- **Ручное тестирование** - без автотестов на первом этапе

### MVP функционал (только высокий приоритет):
1. **Регистрация пользователей** - сбор базовой информации
2. **Напоминания об оплате** - автоматические уведомления

*Примечание: Админ-панель, статистика и интеграции с платежами НЕ входят в MVP*

---

## 3. Структура проекта

### Файловая структура MVP:
```
telegram-bot-vpn/
├── main.py                 # Основной файл бота
├── .env                    # Переменные окружения (секреты)
├── .env.example           # Пример конфигурации 
├── requirements.txt       # Зависимости Python
├── users.db              # SQLite база данных (создается автоматически)
├── .gitignore            # Исключения для git
└── README.md             # Документация запуска
```

### Обоснование простоты:
- **Один файл `main.py`** - вся логика в одном месте
- **Минимум файлов** - легко понять и развернуть  
- **Автоматическое создание БД** - не нужно скриптов миграций
- **Простое развертывание** - скопировал файлы и запустил

### Содержимое main.py:
- Регистрация пользователей
- Планировщик напоминаний
- Базовые команды бота (/start, /register)
- Работа с SQLite базой данных
- Загрузка конфигурации из .env

---

## 4. Архитектура проекта

### Компоненты системы:
```
[Telegram Bot API] 
       ↓
[main.py - Бот-обработчик]
       ↓
[SQLite Database]
       ↓  
[APScheduler - Планировщик]
```

### Основные блоки в main.py:
1. **Bot Handler** - обработка сообщений от пользователей
2. **Database Manager** - простые функции для работы с SQLite
3. **Scheduler** - планирование и отправка напоминаний
4. **Config Loader** - загрузка настроек из .env

### Принципы архитектуры:
- **Все в одном процессе** - нет микросервисов
- **Простые функции** - без классов и наследования  
- **Линейный поток данных** - пользователь → бот → база → планировщик
- **Минимум абстракций** - прямые вызовы функций
- **Монолитная структура** - вся логика в одном файле

---

## 5. Модель данных

### Таблица `users` (SQLite):
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    telegram_id INTEGER UNIQUE NOT NULL,
    username TEXT,
    registration_date DATE NOT NULL,
    payment_due_date DATE NOT NULL,
    is_active BOOLEAN DEFAULT 1
);
```

### Описание полей:
- `id` - внутренний ID (автоинкремент)
- `telegram_id` - ID пользователя в Telegram (уникальный)
- `username` - имя пользователя в Telegram
- `registration_date` - дата регистрации
- `payment_due_date` - дата следующего платежа
- `is_active` - активен ли пользователь (для отключения напоминаний)

### Логика работы с данными:
- **При регистрации**: записываем данные + устанавливаем `payment_due_date` на месяц вперед
- **Планировщик**: ежедневно проверяет `payment_due_date` и отправляет напоминания
- **После оплаты**: обновляем `payment_due_date` на следующий месяц
- **Деактивация**: устанавливаем `is_active = 0` для отключения напоминаний

### Принципы:
- **Одна таблица** - максимальная простота
- **Минимум полей** - только необходимые данные
- **Автоматическое создание** - таблица создается при первом запуске

---

## 6. Работа с LLM

### Подход для MVP:
- **Без LLM** - используем простые предопределенные тексты
- **Статические сообщения** - заранее написанные шаблоны
- **Простые команды** - /start, /register, /help
- **Фиксированные ответы** - без генерации текста

### Обоснование отказа от LLM в MVP:
1. **Простота** - не нужны API ключи и дополнительные зависимости
2. **Скорость** - мгновенные ответы без задержек на запросы к LLM
3. **Надежность** - нет зависимости от внешних сервисов
4. **Стоимость** - бесплатно, без затрат на API
5. **Фокус на MVP** - проверяем основную гипотезу, а не качество текста

### Примеры предопределенных сообщений:
```python
MESSAGES = {
    'welcome': 'Добро пожаловать! Для регистрации нажмите /register',
    'registration_success': 'Вы успешно зарегистрированы!',
    'payment_reminder': 'Напоминание: завтра истекает срок оплаты VPN',
    'payment_due': 'Срок оплаты VPN истек! Пожалуйста, продлите подписку',
    'help': 'Доступные команды: /start, /register, /help'
}
```

### Принципы текстовых сообщений:
- **Краткость** - короткие и понятные сообщения
- **Ясность** - четкие инструкции для пользователя
- **Константы** - все тексты в одном месте для легкого изменения

---

## 7. Мониторинг LLM

### Подход для MVP:
- **Мониторинга LLM НЕТ** - поскольку LLM не используется
- **Простое логирование** - только основные события бота
- **Минимальная телеметрия** - счетчики регистраций и отправленных напоминаний

### Что будем мониторить вместо LLM:
1. **Активность бота** - количество обработанных сообщений
2. **Регистрации** - новые пользователи
3. **Напоминания** - отправленные уведомления
4. **Ошибки** - сбои в работе бота

### Простой мониторинг через логи:
```python
import logging

# Настройка логирования
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('bot.log'),
        logging.StreamHandler()
    ]
)

# Примеры логирования
logging.info(f"New user registered: {user_id}")
logging.info(f"Payment reminder sent to {user_id}")
logging.error(f"Failed to send message to {user_id}: {error}")
logging.info(f"Bot started successfully")
```

### Принципы логирования:
- **Один лог-файл** - `bot.log` для всех событий
- **Простой формат** - время, уровень, сообщение
- **Консоль + файл** - дублирование логов
- **Минимум деталей** - только нужная информация

---

## 8. Сценарии работы

### Сценарий 1: Регистрация нового пользователя
1. Пользователь находит бота в Telegram
2. Отправляет `/start`
3. Бот отвечает приветствием и предлагает `/register`
4. Пользователь отправляет `/register`
5. Бот сохраняет данные пользователя в базу
6. Устанавливает дату следующего платежа (текущая дата + 30 дней)
7. Подтверждает успешную регистрацию

### Сценарий 2: Автоматическое напоминание об оплате
1. Планировщик ежедневно (10:00) проверяет базу данных
2. Находит пользователей с приближающейся датой оплаты (за 3 дня)
3. Отправляет напоминание каждому такому пользователю
4. Логирует отправленные напоминания

### Сценарий 3: Помощь пользователю
1. Пользователь отправляет `/help`
2. Бот отвечает с контактом администратора (логин в Telegram)

### Команды MVP:
- `/start` - приветствие и информация о регистрации
- `/register` - регистрация нового пользователя
- `/help` - контакт администратора

### Пример сообщения `/help`:
```
"По всем вопросам обращайтесь к администратору: @your_telegram_username"
```

### Принципы MVP сценариев:
- **Минимум команд** - только 3 основные команды
- **Простое взаимодействие** - одношаговые операции
- **Прямой контакт** - личный логин админа вместо сложной системы поддержки

---

## 9. Деплой

### Способ развертывания:
- **Прямо на VPN сервере** - там же где работает Amnezia VPN
- **Простое копирование файлов** - без Docker или сложных систем
- **systemd сервис** - для автозапуска бота
- **Ручное управление** - запуск/остановка через команды

### Шаги развертывания:
1. **Копируем файлы** на сервер (`scp` или `rsync`)
2. **Устанавливаем Python 3.13** и зависимости
3. **Настраиваем конфигурацию** (токен бота, пути к файлам)
4. **Настраиваем systemd сервис** для автозапуска
5. **Запускаем бота** и проверяем работу

### Требования к серверу:
- **Ubuntu/Debian** или любой Linux
- **Python 3.13** и pip
- **Доступ в интернет** для Telegram API
- **Права на создание файлов** в директории проекта

### Пример команд развертывания:
```bash
# Копирование на сервер
scp -r telegram-bot-vpn/ user@server:/opt/

# Установка зависимостей
cd /opt/telegram-bot-vpn
pip install -r requirements.txt

# Запуск
python main.py
```

### Принципы деплоя:
- **Максимальная простота** - никаких контейнеров и оркестрации
- **Один сервер** - все на одной машине
- **Минимум настроек** - только необходимое

### Интеграция с Amnezia VPN (будет добавлена после MVP):
- **Протоколы**: OpenVPN и XRay
- **Расположение конфигураций**: `/opt/amnezia/openvpn/` и `/opt/amnezia/xray/`
- **Docker контейнеры**: Каждый протокол работает в отдельном контейнере
- **Управление пользователями**: Через Docker API и файловую систему

### Подход к VPN интеграции в MVP:
```python
# Простая проверка существования VPN конфигурации
AMNEZIA_BASE_DIR = "/opt/amnezia"
OPENVPN_CONFIG_DIR = "/opt/amnezia/openvpn"  
XRAY_CONFIG_DIR = "/opt/amnezia/xray"

def check_vpn_user_exists(telegram_id):
    """Проверяет наличие VPN конфигурации пользователя"""
    openvpn_file = f"{OPENVPN_CONFIG_DIR}/user_{telegram_id}.ovpn"
    xray_file = f"{XRAY_CONFIG_DIR}/user_{telegram_id}.json"
    return os.path.exists(openvpn_file) or os.path.exists(xray_file)
```

---

## 10. Подход к конфигурированию

### Подход к конфигурации для MVP:
- **Константы в коде** - основные настройки прямо в `main.py`
- **Минимум переменных** - только токен бота и критичные параметры
- **Простое изменение** - редактируем файл и перезапускаем
- **Без .env файлов** - пока не нужны, добавим при интеграции с Amnezia VPN

### Основные параметры для настройки:
```python
# Основные настройки в main.py (в начале файла)
BOT_TOKEN = "your_bot_token_here"
ADMIN_USERNAME = "@your_telegram_username"
DATABASE_FILE = "users.db"
PAYMENT_REMINDER_DAYS = 3
CHECK_TIME_HOUR = 10  # Время ежедневной проверки (10:00)
PAYMENT_PERIOD_DAYS = 30  # Период оплаты (30 дней)
```

### Принципы конфигурирования:
- **Жестко заданные значения** - в коде для максимальной простоты
- **Только необходимое** - минимум настроек для MVP
- **Легко найти и изменить** - все константы в начале main.py
- **Понятные имена** - самодокументируемые названия переменных
- **Комментарии** - пояснения для каждой настройки

### Где изменять настройки:
1. **Токен бота** - получить от @BotFather в Telegram
2. **Username администратора** - ваш логин в Telegram для /help
3. **Период напоминаний** - за сколько дней до оплаты напоминать
4. **Время проверки** - когда ежедневно проверять и отправлять напоминания

*Примечание: После изучения структуры Amnezia VPN добавим соответствующие настройки интеграции*

---

## 11. Подход к логгированию

### Принципы логгирования для MVP:
- **Один лог-файл** - `bot.log` для всех событий
- **Дублирование в консоль** - для отладки при разработке  
- **Простой формат** - время, уровень, сообщение
- **Ротация логов** - автоматическая очистка старых записей при превышении размера
- **Минимум детализации** - только необходимая информация

### Что логируем:
```python
# Примеры логирования основных событий
logging.info("Bot started successfully")
logging.info(f"New user registered: {user_id} (@{username})")
logging.info(f"Payment reminder sent to user {user_id}")
logging.warning(f"User {user_id} already registered")
logging.error(f"Failed to send message to {user_id}: {error}")
logging.error(f"Database error: {error}")
logging.info(f"Scheduler started, checking reminders daily at {CHECK_TIME_HOUR}:00")
```

### Настройка логирования:
```python
import logging
from logging.handlers import RotatingFileHandler

# Настройка логгера
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        RotatingFileHandler('bot.log', maxBytes=10*1024*1024, backupCount=3),
        logging.StreamHandler()  # Вывод в консоль
    ]
)
```

### Уровни логирования:
- **INFO** - основные события работы бота (старт, регистрация, отправка напоминаний)
- **WARNING** - предупреждения (повторная регистрация, неизвестные команды)
- **ERROR** - ошибки работы (сбои отправки сообщений, ошибки БД)

### Принципы:
- **Структурированность** - одинаковый формат для похожих событий
- **Информативность** - достаточно данных для диагностики
- **Краткость** - избегаем избыточной информации
- **Безопасность** - не логируем чувствительные данные (токены, пароли)

### Ротация файлов:
- **Максимальный размер** - 10MB на файл
- **Количество бэкапов** - 3 файла (bot.log, bot.log.1, bot.log.2)
- **Автоматическая очистка** - старые логи удаляются автоматически

---

## Заключение

Техническое видение проекта готово! Мы создали максимально простое решение для MVP, следуя принципам KISS:

- ✅ **Простая архитектура** - монолитное приложение в одном файле
- ✅ **Минимум зависимостей** - только необходимые библиотеки
- ✅ **Быстрое развертывание** - копирование файлов и запуск
- ✅ **Базовый функционал** - регистрация и напоминания об оплате
- ✅ **Простое конфигурирование** - константы в коде
- ✅ **Достаточное логирование** - для мониторинга и отладки

Этот документ будет служить техническим руководством для разработки MVP Telegram-бота для напоминаний об оплате VPN.
